{% comment %}
  Mini Golf Game Section for Shopify
  Auto-generated from golf-game.html
  Customizable prizes and marketing URL
{% endcomment %}

<style>
/* Theme integration styles */
.mini-golf-section {
  display: grid;
  grid-template-columns: subgrid;
  grid-column: 1 / -1;
  width: 100%;
  overflow: hidden;
  box-sizing: border-box;
  padding: 0;
}

.mini-golf-container {
  grid-column: 2;
  width: 100%;
  max-width: 800px;
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 400px;
  padding: 0 20px;
  box-sizing: border-box;
}

.mini-golf-container * {
  box-sizing: border-box;
  max-width: 100%;
}

/* Full width adjustments */
.section--full-width .mini-golf-container {
  grid-column: 1 / -1;
  padding: 0 var(--padding-lg, 20px);
}

/* Mobile responsiveness */
@media screen and (max-width: 750px) {
  .mini-golf-section {
    padding: 0;
  }
  .mini-golf-container {
    grid-column: 1 / -1;
    padding: 0 var(--padding-md, 16px);
    width: 100%;
  }
  .mini-golf-container .container {
    padding: 20px 10px;
    width: 100%;
  }
  .mini-golf-container .prize-guide {
    width: 100%;
    margin-left: 0;
    margin-right: 0;
  }
  .mini-golf-container .canvas-container {
    width: 100%;
    overflow: hidden;
  }
  .mini-golf-container canvas {
    max-width: 100%;
  }
}

/* Game-specific styles wrapped to prevent theme conflicts */
.mini-golf-container {

      body {
        margin: 0;
        padding: 20px;
        background: #fff1d4;
        font-family: Arial, sans-serif;
        text-align: center;
      }

      .container {
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        padding: 40px 20px;
        background: #fff1d4;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        box-sizing: border-box;
      }
      h1 {
        color: #02210a;
        margin-bottom: 10px;
      }
      p {
        color: #420d00;
        margin-bottom: 20px;
      }

      .email-form {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 30px;
        flex-wrap: wrap;
      }

      input[type="email"] {
        padding: 12px 16px;
        font-size: 16px;
        border: 1px solid #ccc;
        border-radius: 6px;
        min-width: 250px;
      }

      button {
        padding: 12px 20px;
        font-size: 16px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 600;
      }

      .email-btn {
        background: #923c07;
        color: white;
      }

      .game-btn {
        background: #02210a;
        color: #fff1d4;
        margin: 0 5px;
      }

      .putt-btn {
        background: #ec3c28;
        color: white;
        animation: pulse 1s infinite;
        height: 24px;
        padding: 0 10px;
        line-height: 24px;
        font-size: 12px;
        border: 1px solid #333;
        border-radius: 4px;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }

      #game {
        margin-top: 20px;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease-in, visibility 0s linear 0.3s;
      }

      #game.visible {
        opacity: 1;
        visibility: visible;
        transition: opacity 0.3s ease-in, visibility 0s linear;
      }

      .game-area {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
      }

      .canvas-container {
        position: relative;
        text-align: center;
        overflow: hidden;
        width: 100%;
      }

      canvas {
        max-width: 600px;
        width: 100%;
        display: block;
        margin: 0 auto;
      }

      .putty-character {
        position: absolute;
        left: 15px;
        top: 2px;
        height: 90px;
        pointer-events: none;
      }

      .game-info {
        max-width: 200px;
        text-align: left;
      }

      .stats {
        margin: 10px 0;
        font-weight: bold;
        color: #02210a;
        text-align: center;
        display: none;
      }

      .status {
        margin: 15px 0;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-align: center;
      }

      .instructions {
        background: rgba(2, 33, 10, 0.05);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-size: 14px;
        line-height: 1.4;
        color: #420d00;
      }

      .instructions h3 {
        margin: 0 0 10px 0;
        color: #02210a;
        font-size: 16px;
      }
      /* Prize guide */
      .prize-guide {
        display: flex;
        gap: 8px;
        padding: 10px;
        border-radius: 12px;
        margin-top: 12px;
        background: linear-gradient(135deg, #ffedd5, #ffe4e0);
        border: 2px solid rgba(0, 0, 0, 0.1);
        justify-content: space-between;
        align-items: stretch;
        width: 100%;
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
        box-sizing: border-box;
      }
      .prize-segment {
        flex: 1;
        min-width: 0;
        max-width: calc(20% - 6.4px); /* 20% width minus gap */
        padding: 8px;
        border-radius: 8px;
        text-align: center;
        color: #1b1000;
        background: rgba(255, 255, 255, 0.6);
        border: 1px solid rgba(0, 0, 0, 0.08);
        transition: transform 120ms ease, box-shadow 120ms ease;
        position: relative;
        z-index: 1;
        box-sizing: border-box;
      }
      .prize-segment .shot-label {
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.3px;
        opacity: 0.8;
      }
      .prize-segment .prize-name {
        font-size: 13px;
        font-weight: 800;
        margin-top: 4px;
        white-space: wrap;
        overflow: wrap;
        word-wrap: break-word;
        text-overflow: visible;
      }
      .prize-segment .prize-desc {
        font-size: 12px;
        opacity: 0.8;
        white-space: wrap;
        overflow: visible;
      }
      .prize-segment.active {
        box-shadow: 0 8px 22px rgba(0, 0, 0, 0.18);
        background: #fff;
        border-color: #ec3c28;
        outline: 3px solid rgba(236, 60, 40, 0.2);
        position: relative;
      }
      .prize-segment.active::after {
        content: "NEXT";
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ec3c28;
        color: #fff;
        font-weight: 800;
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 999px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        z-index: 3;
      }

      /* Pulsing accent per segment when active */
      @keyframes pulseGreen {
        0% {
          box-shadow: 0 0 0 0 rgba(22, 163, 74, 0.45);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(22, 163, 74, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(22, 163, 74, 0);
        }
      }
      @keyframes pulseBlue {
        0% {
          box-shadow: 0 0 0 0 rgba(2, 132, 199, 0.45);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(2, 132, 199, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(2, 132, 199, 0);
        }
      }
      @keyframes pulsePurple {
        0% {
          box-shadow: 0 0 0 0 rgba(124, 58, 237, 0.45);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(124, 58, 237, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(124, 58, 237, 0);
        }
      }
      @keyframes pulseAmber {
        0% {
          box-shadow: 0 0 0 0 rgba(217, 119, 6, 0.45);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(217, 119, 6, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(217, 119, 6, 0);
        }
      }
      @keyframes pulseRed {
        0% {
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.45);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(220, 38, 38, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(220, 38, 38, 0);
        }
      }

      .seg-1.active {
        border-color: #16a34a;
        outline-color: rgba(22, 163, 74, 0.25);
        animation: pulseGreen 1.6s ease-out infinite;
      }
      .seg-2.active {
        border-color: #0284c7;
        outline-color: rgba(2, 132, 199, 0.25);
        animation: pulseBlue 1.6s ease-out infinite;
      }
      .seg-3.active {
        border-color: #7c3aed;
        outline-color: rgba(124, 58, 237, 0.25);
        animation: pulsePurple 1.6s ease-out infinite;
      }
      .seg-4.active {
        border-color: #d97706;
        outline-color: rgba(217, 119, 6, 0.25);
        animation: pulseAmber 1.6s ease-out infinite;
      }
      .seg-5.active {
        border-color: #dc2626;
        outline-color: rgba(220, 38, 38, 0.25);
        animation: pulseRed 1.6s ease-out infinite;
      }

      @media (max-width: 600px) {
        .prize-guide {
          flex-direction: column;
          gap: 6px;
          padding: 8px;
          width: 100%;
        }
        .prize-segment {
          padding: 6px;
          max-width: 100%;
          width: 100%;
        }
        .prize-segment .shot-label {
          font-size: 11px;
        }
        .prize-segment .prize-name {
          font-size: 12px;
        }
        .prize-segment .prize-desc {
          font-size: 11px;
        }
      }
      .seg-1 {
        background: linear-gradient(180deg, #dcfce7, #bbf7d0);
      }
      .seg-2 {
        background: linear-gradient(180deg, #e0f2fe, #bae6fd);
      }
      .seg-3 {
        background: linear-gradient(180deg, #ede9fe, #ddd6fe);
      }
      .seg-4 {
        background: linear-gradient(180deg, #fef3c7, #fde68a);
      }
      .seg-5 {
        background: linear-gradient(180deg, #fee2e2, #fecaca);
      }
      /* HTML UI above the canvas */
      .ui-row {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin-bottom: 4px;
        flex-wrap: wrap;
      }
      .power-meter {
        position: relative;
        width: 160px;
        height: 24px;
        background: linear-gradient(90deg, #ffffff, #ec3c28);
        border: 1px solid #333;
        border-radius: 4px;
        overflow: hidden;
      }
      .power-tick {
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
        background: #000;
      }
      .putt-btn:disabled {
        background: #bdbdbd;
        color: #eeeeee;
        cursor: not-allowed;
        animation: none;
      }

      .power-display {
        text-align: center;
        margin: 10px 0;
        font-weight: bold;
        color: #02210a;
        font-size: 18px;
      }

      .status.ready {
        background: rgba(2, 33, 10, 0.1);
        color: #02210a;
      }
      .status.aiming {
        background: rgba(2, 33, 10, 0.08);
        color: #02210a;
      }
      .status.shooting {
        background: rgba(2, 33, 10, 0.08);
        color: #02210a;
      }
      .status.neutral {
        background: rgba(2, 33, 10, 0.08);
        color: #02210a;
      }

      .prize {
        display: none;
        background: linear-gradient(135deg, #4caf50, #45a049);
        color: white;
        padding: 30px;
        border-radius: 16px;
        margin: 20px auto;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        width: 100%;
        max-width: 400px;
        gap: 10px;
        flex-shrink: 0;
        flex-grow: 1;
        box-sizing: border-box;
      }

      .lose {
        display: none;
        background: linear-gradient(135deg, #f44336, #d32f2f);
        color: white;
        padding: 30px;
        border-radius: 16px;
        margin: 20px 0;
      }

      .code {
        background: rgba(255, 255, 255, 0.2);
        padding: 12px 24px;
        border-radius: 8px;
        font-family: monospace;
        font-size: 1.4em;
        font-weight: bold;
        letter-spacing: 2px;
        margin: 10px 0;
        border: 2px dashed rgba(255, 255, 255, 0.5);
        min-width: 200px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* Responsive design */
      @media (max-width: 768px) {
        .game-area {
          flex-direction: column;
          align-items: center;
          width: 100%;
        }

        .game-info {
          width: 100%;
          max-width: 100%;
          text-align: center;
        }

        .instructions {
          text-align: left;
          max-width: 350px;
          width: 100%;
        }

        .putty-character {
          height: 60px;
          left: 10px;
          top: 2px;
        }

        .canvas-container {
          width: 100%;
          overflow: hidden;
        }

        canvas {
          max-width: 100%;
          width: 100%;
        }

        .ui-row {
          width: 100%;
          max-width: 100%;
          justify-content: center;
          gap: 8px;
        }

        .power-meter {
          max-width: 160px;
          width: 50%;
        }
      }

      @media (max-width: 480px) {
        .container {
          padding: 20px 10px;
          width: 100%;
          margin: 0;
        }

        .email-form {
          flex-direction: column;
          align-items: center;
          width: 100%;
        }

        input[type="email"] {
          width: 100%;
          max-width: 280px;
          min-width: 200px;
          margin-bottom: 10px;
        }

        /* Compact headings and subtitle */
        h1 {
          margin: 8px 0 4px 0;
          font-size: 24px;
        }
        p {
          margin: 6px 0 8px 0;
          font-size: 16px;
        }

        /* Override inline spacing in email form */
        #email-form {
          margin-top: 10px !important;
          gap: 6px !important;
          width: 100%;
        }
        #email-form input[type="email"] {
          padding: 8px 10px !important;
          font-size: 14px !important;
          min-width: 200px !important;
          width: 100% !important;
          max-width: 280px !important;
        }
        #email-form button {
          padding: 10px 14px !important;
          font-size: 14px !important;
          width: 100% !important;
          max-width: 280px !important;
        }

        .putty-character {
          height: 45px;
          left: 8px;
          top: 0px;
        }

        .prize-guide {
          padding: 8px;
          gap: 6px;
        }

        .prize-segment {
          padding: 6px;
        }

        .prize {
          margin: 20px auto;
          padding: 20px;
          width: calc(100% - 20px);
          max-width: 400px;
        }

        .code {
          font-size: 1em;
          padding: 6px 12px;
        }
      }
    
}
</style>

{% liquid
  case section.settings.content_width
    when 'content-center-aligned'
      assign content_width = 'page-width'
    when 'content-full-width'
      assign content_width = 'full-width'
  endcase
%}

<div class="section-background color-{{ section.settings.color_scheme }}"></div>
<div
  class="mini-golf-section section section--{{ content_width }} spacing-style color-{{ section.settings.color_scheme }} relative"
  style="{% render 'spacing-style', settings: section.settings %}"
>

    <div class="mini-golf-container">
      <h1>Play with Putty!</h1>
      <p>Enter your email and win prizes!</p>

      <!-- Email Form -->
      <div id="emailSection-{{ section.id }}">
        <!-- Email Signup Form for Mini Golf -->
        <form
          id="email-form-{{ section.id }}"
          style="margin-top: 30px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap"
          onsubmit="window.GolfGameHandleFormSubmit(event)"
        >
          <input
            type="email"
            name="email"
            id="email-{{ section.id }}"
            required
            placeholder="{{ section.settings.email_placeholder | default: "you@domain.com" }}"
            style="
              padding: 12px 16px;
              font-size: 16px;
              border: 1px solid #ccc;
              border-radius: 6px;
              min-width: 280px;
              font-family: 'General Sans', sans-serif;
            "
          />
          <button
            type="submit"
            style="
              background-color: #923c07;
              color: white;
              padding: 12px 20px;
              font-size: 16px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-family: 'General Sans', sans-serif;
            "
          >
            {{ section.settings.submit_button_text | default: "Let's Putt!" }}
          </button>
        </form>
      </div>

      <!-- Game -->
      <div id="game-{{ section.id }}">
        <div id="status-{{ section.id }}" class="status aiming">Watch the power meter and click PUTT to shoot!</div>
        <div class="game-area">
          <div class="canvas-container">
            <div id="uiRow-{{ section.id }}" class="ui-row">
              <button id="puttHtmlBtn-{{ section.id }}" class="game-btn putt-btn">PUTT_BUTTON_TEXT</button>
              <div id="powerMeter-{{ section.id }}" class="power-meter"><div id="powerTick-{{ section.id }}" class="power-tick"></div></div>
            </div>
            <canvas id="canvas-{{ section.id }}" style="width: 600px; height: 80px" width="600" height="80"></canvas>
            <!-- <img src="putty.png" alt="Putty" class="putty-character" /> -->
          </div>
          <div id="prizeGuide-{{ section.id }}" class="prize-guide">
            <div class="prize-segment seg-1" data-shots="1">
              <div class="prize-name" id="seg1Name-{{ section.id }}">Free game!</div>
              <div class="prize-desc" id="seg1Desc-{{ section.id }}">{{ section.settings.prize_1_desc | default: "Free Round" }}</div>
            </div>
            <div class="prize-segment seg-2" data-shots="2">
              <div class="prize-name" id="seg2Name-{{ section.id }}">{{ section.settings.prize_2_name | default: "Eagle!" }}</div>
              <div class="prize-desc" id="seg2Desc-{{ section.id }}">{{ section.settings.prize_2_desc | default: "Free Appetizer" }}</div>
            </div>
            <div class="prize-segment seg-3" data-shots="3">
              <div class="prize-name" id="seg3Name-{{ section.id }}">{{ section.settings.prize_3_name | default: "Birdie!" }}</div>
              <div class="prize-desc" id="seg3Desc-{{ section.id }}">{{ section.settings.prize_3_desc | default: "10% Off Your Order" }}</div>
            </div>
            <div class="prize-segment seg-4" data-shots="4">
              <div class="prize-name" id="seg4Name-{{ section.id }}">{{ section.settings.prize_4_name | default: "Par" }}</div>
              <div class="prize-desc" id="seg4Desc-{{ section.id }}">{{ section.settings.prize_4_desc | default: "5% Off Your Order" }}</div>
            </div>
            <div class="prize-segment seg-5" data-shots="5">
              <div class="prize-name" id="seg5Name-{{ section.id }}">{{ section.settings.prize_5_name | default: "Bogey" }}</div>
              <div class="prize-desc" id="seg5Desc-{{ section.id }}">{{ section.settings.prize_5_desc | default: "$2 Off Your Order" }}</div>
            </div>
          </div>

          <div class="game-info">
            <!-- <div class="instructions">
              <h3>How to Play</h3>
              <p>🎯 Watch the power meter bounce</p>
              <p>⏱️ Click PUTT at the right moment</p>
              <p>🏌️ Reach exactly 10 units to win!</p>
              <p>⚠️ Don't overshoot or you lose</p>
            </div> -->

            <div class="stats">
              <div><span id="shots-{{ section.id }}">Shots: 0</span></div>
              <div><span id="distance-{{ section.id }}">Distance to go: 10</span></div>
            </div>
          </div>
        </div>
        <button id="puttBtn-{{ section.id }}" class="game-btn putt-btn" onclick="GolfGamePutt()" style="display: none">🏌️ PUTT!</button>
      </div>

      <!-- Prize -->
      <div id="prize-{{ section.id }}" class="prize">
        <h2 id="prizeTitle-{{ section.id }}" style="margin: 0px">🎉 You Won!</h2>
        <p id="prizeDesc-{{ section.id }}" style="margin: 0">Amazing prize!</p>
        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px">
          Your Code: <span id="prizeCode-{{ section.id }}" class="code">CODE123</span>
        </div>
        <button
          class="game-btn"
          onclick="GolfGameReset()"
          style="background: rgba(255, 255, 255, 0.2); border: 2px solid white"
        >
          Play Again
        </button>
      </div>

      <!-- Lose -->
      <div id="lose-{{ section.id }}" class="lose">
        <h2>Oops! You overshot!</h2>
        <p>Don't worry, try again!</p>
        <button
          class="game-btn"
          onclick="GolfGameReset()"
          style="background: rgba(255, 255, 255, 0.2); border: 2px solid white"
        >
          🔄 Try Again
        </button>
      </div>
    </div>

    
  
</div>

<script>
  (function() {
    const sectionId = "{{ section.id }}";
    

      const GAME_TITLE = {{ section.settings.game_title | default: "Mini Golf with Putty" | json }};
      const GAME_SUBTITLE = {{ section.settings.game_subtitle | default: "Enter your email and win prizes!" | json }};
      const EMAIL_PLACEHOLDER = {{ section.settings.email_placeholder | default: "you@domain.com" | json }};
      const SUBMIT_BUTTON_TEXT = {{ section.settings.submit_button_text | default: "Let's Putt!" | json }};
      const AIM_BANNER_TEXT = {{ section.settings.aim_banner_text | default: "Watch the power meter and click PUTT when ready!" | json }};
      const MARKETING_URL = {{ section.settings.marketing_url | json }};
      const PUTTY_IMAGE_URL = {{ section.settings.putty_image | image_url | json }};
      const PUTT_BUTTON_TEXT = {{ section.settings.putt_button_text | default: "PUTT!" | json }};
      const PUTT_DISABLED_BUTTON_TEXT = {{ section.settings.putt_disabled_button_text | default: "Enter email to play" | json }};
      // Power meter and UI constants
      const METER_WIDTH = 160;
      const CANVAS_HEIGHT = 80;
      const UI_BAR_HEIGHT = 24;
      const PRIZE_1_NAME = {{ section.settings.prize_1_name | default: "Hole in One!" | json }};
      const PRIZE_1_CODE = {{ section.settings.prize_1_code | default: "HOLEINONE" | json }};
      const PRIZE_1_DESC = {{ section.settings.prize_1_desc | default: "Free Round" | json }};
      const PRIZE_2_NAME = {{ section.settings.prize_2_name | default: "Eagle!" | json }};
      const PRIZE_2_CODE = {{ section.settings.prize_2_code | default: "EAGLE2023" | json }};
      const PRIZE_2_DESC = {{ section.settings.prize_2_desc | default: "Free Appetizer" | json }};
      const PRIZE_3_NAME = {{ section.settings.prize_3_name | default: "Birdie!" | json }};
      const PRIZE_3_CODE = {{ section.settings.prize_3_code | default: "BIRDIE10" | json }};
      const PRIZE_3_DESC = {{ section.settings.prize_3_desc | default: "10% Off Your Order" | json }};
      const PRIZE_4_NAME = {{ section.settings.prize_4_name | default: "Par" | json }};
      const PRIZE_4_CODE = {{ section.settings.prize_4_code | default: "PAR5OFF" | json }};
      const PRIZE_4_DESC = {{ section.settings.prize_4_desc | default: "5% Off Your Order" | json }};
      const PRIZE_5_NAME = {{ section.settings.prize_5_name | default: "Bogey" | json }};
      const PRIZE_5_CODE = {{ section.settings.prize_5_code | default: "BOGEY2" | json }};
      const PRIZE_5_DESC = {{ section.settings.prize_5_desc | default: "$2 Off Your Order" | json }};

      const PUTTY_X_OFFSET = 15;
      const PUTTY_Y_OFFSET = -5;

      const TICK_SPEED = 2;

      // Game state
      let shots = 0,
        distance = 0,
        target = 10;
      let powerTick = 0,
        tickDir = 1,
        power = 1;
      let animId = null,
        ballAnimId = null;
      let ballStart = 0,
        ballTarget = 0,
        ballAnimStart = 0;
      let state = "email"; // email, ready, aiming, shooting, won, lost

      // HTML UI refs
      const powerMeterEl = document.getElementById("powerMeter-{{ section.id }}");
      const powerTickEl = document.getElementById("powerTick-{{ section.id }}");
      const puttHtmlBtn = document.getElementById("puttHtmlBtn-{{ section.id }}");
      puttHtmlBtn.addEventListener("click", () => {
        if (!puttHtmlBtn.disabled) {
          GolfGamePutt();
        }
      });

      // Game state and refs
      let puttyLoaded = false;
      const canvas = document.getElementById("canvas-{{ section.id }}");
      const ctx = canvas.getContext("2d");
      // HiDPI scaling for crisp rendering and responsive width
      function setupHiDPI() {
        const dpr = window.devicePixelRatio || 1;
        const container = canvas.closest(".canvas-container");
        const maxWidth = 600;

        // Get container width, defaulting to max if not available
        let containerWidth = maxWidth;
        if (container) {
          // Force a reflow to get accurate size
          container.offsetHeight;
          const rect = container.getBoundingClientRect();
          containerWidth = Math.min(maxWidth, Math.max(320, rect.width));
        }

        // Set display size (CSS pixels)
        canvas.style.width = containerWidth + "px";
        canvas.style.height = CANVAS_HEIGHT + "px";

        // Set actual size in memory (scaled for retina)
        canvas.width = Math.floor(containerWidth * dpr);
        canvas.height = Math.floor(CANVAS_HEIGHT * dpr);

        // Reset transform and set scale for retina
        ctx.setTransform(1, 0, 0, 1, 0, 0);
        ctx.scale(dpr, dpr);

        // Store the current width for draw() to use
        canvas.dataset.currentWidth = containerWidth;
      }
      // Initial setup and resize handling
      window.addEventListener("resize", () => {
        setupHiDPI();
        draw();
      });

      // Force a resize event to ensure initial sizing
      window.dispatchEvent(new Event("resize"));

      // Putty image
      const puttyImg = new Image();
      puttyImg.onload = () => {
        puttyLoaded = true;
        draw();
      };
      puttyImg.src = PUTTY_IMAGE_URL;

      // No canvas button anymore; using HTML button

      // Prize data
      const prizes = [
        { name: PRIZE_1_NAME, code: PRIZE_1_CODE, desc: PRIZE_1_DESC },
        { name: PRIZE_2_NAME, code: PRIZE_2_CODE, desc: PRIZE_2_DESC },
        { name: PRIZE_3_NAME, code: PRIZE_3_CODE, desc: PRIZE_3_DESC },
        { name: PRIZE_4_NAME, code: PRIZE_4_CODE, desc: PRIZE_4_DESC },
        { name: PRIZE_5_NAME, code: PRIZE_5_CODE, desc: PRIZE_5_DESC },
      ];

      function updatePrizeGuide() {
        const segments = document.querySelectorAll(".prize-segment");
        segments.forEach((seg) => seg.classList.remove("active"));
        // If we're shooting, don't update highlight yet
        if (state === "shooting") return;

        // If won, highlight the achieved prize segment
        if (state === "won") {
          const achieved = Math.min(shots, 5);
          const achievedEl = document.querySelector(`.prize-segment[data-shots="${achieved}"]`);
          if (achievedEl) achievedEl.classList.add("active");
          return;
        }

        // Otherwise highlight next potential zone (current shots + 1)
        const next = Math.min(shots + 1, 5);
        const active = document.querySelector(`.prize-segment[data-shots="${next}"]`);
        if (active) active.classList.add("active");
      }

      // Handle form submission with preventDefault
      window.GolfGameHandleFormSubmit = function (event) {
        event.preventDefault();
        event.stopPropagation();

        const form = event.target;
        const formData = new FormData(form);
        const email = formData.get("email");

        if (!email || !email.includes("@")) {
          alert("Please enter a valid email address");
          return;
        }

        if (MARKETING_URL) {
          fetch(MARKETING_URL, {
            method: "POST",
            body: formData,
            mode: "no-cors",
          }).catch((error) => console.log("Email service error:", error));
        } else {
          console.log("No mail list configured, skipping.");
        }

        // Start the game immediately
        GolfGameStartGame();
      };

      // Start game after email (called by form submission)
      function syncPuttButton() {
        const btn = document.getElementById("puttHtmlBtn-{{ section.id }}");
        if (!btn) return;
        if (state === "email") {
          btn.disabled = true;
          btn.textContent = PUTT_DISABLED_BUTTON_TEXT;
          return;
        }
        const shouldEnable = state === "aiming";
        btn.disabled = !shouldEnable;
        btn.textContent = PUTT_BUTTON_TEXT;
      }

      window.GolfGameStartGame = function () {
        showEmail(false);
        showGame(true);
        showAimBanner(true);

        // Auto-start aiming instead of requiring button click
        state = "aiming";
        startAiming();
        draw();
        syncPuttButton();
        // Do not pre-highlight during shooting; update happens after shot resolves
      };

      // Take shot
      window.GolfGamePutt = function () {
        if (state !== "aiming") return;

        cancelAnimationFrame(animId);
        animId = null;
        state = "shooting";
        shots++;

        ballStart = distance;
        ballTarget = distance + power;
        ballAnimStart = performance.now();

        document.getElementById("status-{{ section.id }}").textContent = AIM_BANNER_TEXT;
        document.getElementById("status-{{ section.id }}").className = "status neutral";
        updateStats();
        if (typeof updatePrizeGuide === "function") updatePrizeGuide();
        if (typeof syncPuttButton === "function") syncPuttButton();
        syncPuttButton();

        // Animate ball
        function animateBall() {
          const elapsed = performance.now() - ballAnimStart;
          const progress = Math.min(elapsed / 1000, 1);

          draw();

          if (progress < 1) {
            ballAnimId = requestAnimationFrame(animateBall);
          } else {
            // Finalize distance with bounce-back if overshot
            const total = ballTarget;
            const overshoot = total - target;
            const finalDistance = overshoot > 0 ? Math.max(0, target - overshoot) : total;
            distance = finalDistance;
            updateStats();
            if (typeof updatePrizeGuide === "function") updatePrizeGuide();
            checkEnd();
          }
        }
        animateBall();
      };

      // Reset game
      window.GolfGameReset = function () {
        shots = 0;
        distance = 0;
        power = 1;
        powerTick = 0;
        tickDir = 1;
        ballStart = 0;
        ballTarget = 0;
        ballAnimStart = 0;
        state = "email";

        if (animId) cancelAnimationFrame(animId);
        if (ballAnimId) cancelAnimationFrame(ballAnimId);
        animId = null;
        ballAnimId = null;

        showPrizeBanner(false);
        showLoseBanner(false);
        GolfGameStartGame();
        updateStats();
        if (typeof updatePrizeGuide === "function") updatePrizeGuide();
        if (typeof syncPuttButton === "function") syncPuttButton();
      };

      // Start aiming phase
      function startAiming() {
        // Ensure only one aim animation loop is running
        if (animId) {
          cancelAnimationFrame(animId);
          animId = null;
        }
        // Start power meter animation
        function animate() {
          if (state !== "aiming" && state !== "email") return;

          powerTick += TICK_SPEED * tickDir;
          if (powerTick <= 0) {
            powerTick = 0;
            tickDir = 1;
          }
          // meter width is METER_WIDTH, use that as max
          if (powerTick >= METER_WIDTH) {
            powerTick = METER_WIDTH;
            tickDir = -1;
          }

          power = Math.round(1 + (powerTick / METER_WIDTH) * 9);
          if (powerTickEl) {
            powerTickEl.style.left = `${powerTick}px`;
          }
          draw();
          animId = requestAnimationFrame(animate);
        }
        animate();
      }

      // Check win/lose
      function checkEnd() {
        if (distance === target) {
          // Win!
          state = "won";
          const prize = prizes[shots - 1] || prizes[4]; // shots is 1-based, array is 0-based
          showPrizeBanner(true, prize);
          // Hide game area on win
          showGame(false, true); // true for win hide
          if (typeof updatePrizeGuide === "function") updatePrizeGuide();
        } else {
          // Continue - auto-start aiming again
          state = "aiming";
          showAimBanner(true);
          startAiming();
          if (typeof updatePrizeGuide === "function") updatePrizeGuide();
          syncPuttButton();
        }
      }

      // Update stats display
      function updateStats() {
        document.getElementById("shots-{{ section.id }}").textContent = `Shots: ${shots}`;
        document.getElementById("distance-{{ section.id }}").textContent = `Distance to go: ${target - distance}`;
      }

      function showEmail(show = true) {
        document.getElementById("emailSection-{{ section.id }}").style.display = show ? "block" : "none";
      }

      function showGame(show = true, isWinHide = false) {
        const game = document.getElementById("game-{{ section.id }}");
        if (show) {
          game.style.display = "block";
          // Force reflow
          game.offsetHeight;
          game.classList.add("visible");
        } else {
          game.classList.remove("visible");
          if (isWinHide) {
            // After winning, hide immediately
            game.style.display = "none";
          }
        }
      }

      function showStatusBanner(show = true, text, state) {
        document.getElementById("status-{{ section.id }}").style.display = show ? "block" : "none";
        if (show) {
          document.getElementById("status-{{ section.id }}").textContent = text;
          document.getElementById("status-{{ section.id }}").className = `status ${state}`;
        }
      }

      function showAimBanner(show = true) {
        showStatusBanner(show, AIM_BANNER_TEXT, "neutral");
      }

      function showPrizeBanner(show = true, prize = null) {
        document.getElementById("prize-{{ section.id }}").style.display = show ? "flex" : "none";
        if (prize) {
          document.getElementById("prizeTitle-{{ section.id }}").textContent = `🎉 ${prize.name}`;
          document.getElementById("prizeDesc-{{ section.id }}").textContent = prize.desc;
          document.getElementById("prizeCode-{{ section.id }}").textContent = prize.code;
        }
      }

      function showLoseBanner(show = true) {
        document.getElementById("lose-{{ section.id }}").style.display = show ? "block" : "none";
      }

      // Draw game
      function draw() {
        const dpr = window.devicePixelRatio || 1;

        // Clear using logical (CSS) dimensions
        ctx.clearRect(0, 0, canvas.width / dpr, canvas.height / dpr);

        // Use stored width or fallback to style width
        const cssWidth = parseFloat(canvas.dataset.currentWidth || canvas.style.width || "600");

        // Compute current CSS width for responsive lane length

        // Lane (golf course) - centered with 80% width
        const laneWidth = cssWidth * 0.8; // 80% of container width
        const laneStartX = (cssWidth - laneWidth) / 2; // center horizontally
        const laneEndX = laneStartX + laneWidth;
        const ballStartX = laneStartX + 80; // Start ball well to the right of Putty
        ctx.fillStyle = "#314027";
        ctx.fillRect(laneStartX, 40, laneWidth, 30);

        // Putty character inside canvas, aligned bottom with grass (draw at native resolution for quality)
        if (puttyLoaded) {
          const grassBottom = 40 + 30;
          const puttyHeight = 60; // Reduced to fit better in canvas
          const puttyY = grassBottom - puttyHeight + PUTTY_Y_OFFSET;
          // Ensure putty stands on the green near the start
          const puttyX = laneStartX + PUTTY_X_OFFSET;
          // Draw from source at intrinsic pixel dimensions, then scale with canvas transform for crispness
          const aspect = puttyImg.width / puttyImg.height || 1;
          const drawW = puttyHeight * aspect;
          ctx.imageSmoothingEnabled = false;
          ctx.drawImage(puttyImg, puttyX, puttyY, drawW, puttyHeight);
          ctx.imageSmoothingEnabled = true;
        }

        // Hole (white fill, black border) positioned near lane end
        const holeCenterX = laneEndX - 10;
        ctx.fillStyle = "#ffffff";
        ctx.beginPath();
        ctx.arc(holeCenterX, 55, 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 2;
        ctx.stroke();

        // Flag
        ctx.strokeStyle = "#000";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(holeCenterX, 55);
        ctx.lineTo(holeCenterX, 15);
        ctx.stroke();
        ctx.fillStyle = "#EC3C28";
        ctx.beginPath();
        ctx.moveTo(holeCenterX, 15);
        ctx.lineTo(holeCenterX + 20, 20);
        ctx.lineTo(holeCenterX, 25);
        ctx.fill();

        // Ball
        let ballDist = distance;
        if (state === "shooting" && ballAnimStart > 0) {
          const elapsed = performance.now() - ballAnimStart;
          const progress = Math.min(elapsed / 1000, 1);
          const eased = 1 - Math.pow(1 - progress, 3);
          const rawDist = ballStart + (ballTarget - ballStart) * eased;
          ballDist = rawDist > target ? Math.max(0, target - (rawDist - target)) : rawDist;
        }

        // Map distance [0..target] to lane X range [laneStartX..holeCenterX]
        const mappingWidth = Math.max(1, holeCenterX - laneStartX);
        const ballX = ballStartX + (ballDist / target) * (mappingWidth - 80); // Adjust mapping to account for ball start
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(ballX, 55, 6, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "#ccc";
        ctx.lineWidth = 1;
        ctx.stroke();

        // Power meter and button are HTML elements now
      }

      // Initialize game after images and layout are ready
      function initGame() {
        function init() {
          // Force initial sizing
          setupHiDPI();

          // Set initial button state
          const initialBtn = document.getElementById("puttHtmlBtn-{{ section.id }}");
          if (initialBtn) {
            initialBtn.disabled = true;
            initialBtn.textContent = PUTT_DISABLED_BUTTON_TEXT;
          }

          // Initial draw to set canvas size
          draw();

          // Wait for layout to settle, then show game
          setTimeout(() => {
            setupHiDPI();
            draw();

            // Show game elements with fade
            showGame(true);
            showAimBanner(false);
            startAiming();
            if (typeof updatePrizeGuide === "function") updatePrizeGuide();
          }, 100);
        }

        // Wait for next frame to ensure DOM is ready
        requestAnimationFrame(init);
      }

      // Wait for DOM content and images
      if (document.readyState === "complete") {
        initGame();
      } else {
        window.addEventListener("load", initGame);
      }
    
  })();
</script>

{% schema %}
{
  "name": "Mini Golf Game",
  "tag": "section",
  "class": "mini-golf-section",
  "settings": [
    {
      "type": "header",
      "content": "Game Content"
    },
    {
      "type": "text",
      "id": "aim_banner_text",
      "label": "Aim Banner Text",
      "default": "Watch the power meter and click PUTT when ready!"
    },
    {
      "type": "text",
      "id": "game_title",
      "label": "Game Title",
      "default": "Mini Golf with Putty"
    },
    {
      "type": "text",
      "id": "game_subtitle",
      "label": "Game Subtitle",
      "default": "Enter your email and win prizes!"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Placeholder",
      "default": "you@domain.com"
    },
    {
      "type": "text",
      "id": "submit_button_text",
      "label": "Submit Button Text",
      "default": "Let's Putt!"
    },
    {
      "type": "header",
      "content": "Marketing Integration"
    },
    {
      "type": "text",
      "id": "marketing_url",
      "label": "Marketing URL",
      "info": "URL to submit email addresses to (e.g., Klaviyo, Mailchimp, etc.)"
    },
    {
      "type": "header",
      "content": "Layout & Design"
    },
    {
      "type": "select",
      "id": "content_width",
      "label": "Section Width",
      "options": [
        {
          "value": "content-center-aligned",
          "label": "Page Width"
        },
        {
          "value": "content-full-width",
          "label": "Full Width"
        }
      ],
      "default": "content-center-aligned"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "Color Scheme",
      "default": "scheme-1"
    },
    {
      "type": "range",
      "id": "padding-block-start",
      "label": "Top Padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding-block-end",
      "label": "Bottom Padding",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "default": 36
    },
    {
      "type": "header",
      "content": "Game Assets"
    },

    {
      "type": "text",
      "id": "putt_button_text",
      "label": "Putt Button Text",
      "default": "PUTT!"
    },
    {
      "type": "text",
      "id": "putt_disabled_button_text",
      "label": "Disabled Putt Button Text",
      "default": "Enter email to play",
      "info": "Text shown on the PUTT button before email is submitted"
    },
    {
      "type": "image_picker",
      "id": "putty_image",
      "label": "Putty Character Image",
      "info": "Upload a custom image for the Putty character (recommended: square image, 60-90px)"
    },
    {
      "type": "header",
      "content": "Prize 1 (1 Shot - Hole in One)"
    },
    {
      "type": "text",
      "id": "prize_1_name",
      "label": "Prize 1 Name",
      "default": "Hole in One!"
    },
    {
      "type": "text",
      "id": "prize_1_code",
      "label": "Prize 1 Code",
      "default": "HOLEINONE"
    },
    {
      "type": "text",
      "id": "prize_1_desc",
      "label": "Prize 1 Description",
      "default": "Free Round"
    },
    {
      "type": "header",
      "content": "Prize 2 (2 Shots - Eagle)"
    },
    {
      "type": "text",
      "id": "prize_2_name",
      "label": "Prize 2 Name",
      "default": "Eagle!"
    },
    {
      "type": "text",
      "id": "prize_2_code",
      "label": "Prize 2 Code",
      "default": "EAGLE2023"
    },
    {
      "type": "text",
      "id": "prize_2_desc",
      "label": "Prize 2 Description",
      "default": "Free Appetizer"
    },
    {
      "type": "header",
      "content": "Prize 3 (3 Shots - Birdie)"
    },
    {
      "type": "text",
      "id": "prize_3_name",
      "label": "Prize 3 Name",
      "default": "Birdie!"
    },
    {
      "type": "text",
      "id": "prize_3_code",
      "label": "Prize 3 Code",
      "default": "BIRDIE10"
    },
    {
      "type": "text",
      "id": "prize_3_desc",
      "label": "Prize 3 Description",
      "default": "10% Off Your Order"
    },
    {
      "type": "header",
      "content": "Prize 4 (4 Shots - Par)"
    },
    {
      "type": "text",
      "id": "prize_4_name",
      "label": "Prize 4 Name",
      "default": "Par"
    },
    {
      "type": "text",
      "id": "prize_4_code",
      "label": "Prize 4 Code",
      "default": "PAR5OFF"
    },
    {
      "type": "text",
      "id": "prize_4_desc",
      "label": "Prize 4 Description",
      "default": "5% Off Your Order"
    },
    {
      "type": "header",
      "content": "Prize 5 (5+ Shots - Bogey)"
    },
    {
      "type": "text",
      "id": "prize_5_name",
      "label": "Prize 5 Name",
      "default": "Bogey"
    },
    {
      "type": "text",
      "id": "prize_5_code",
      "label": "Prize 5 Code",
      "default": "BOGEY2"
    },
    {
      "type": "text",
      "id": "prize_5_desc",
      "label": "Prize 5 Description",
      "default": "$2 Off Your Order"
    }
  ],
  "presets": [
    {
      "name": "Mini Golf Game"
    }
  ]
}
{% endschema %}